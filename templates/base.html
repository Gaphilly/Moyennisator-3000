<!DOCTYPE html>
<html lang="{{ get_locale() or 'fr' }}">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N821WZKKL9"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-N821WZKKL9');
    </script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" href="/static/favicon.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">

    <title>{% block title %}Moyennisator 3000{% endblock %}</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="Moyennisator 3000 - Analysez vos performances académiques avec des statistiques détaillées sur le Brevet. Suivez vos progrès et améliorez vos résultats scolaires.">
    <meta name="keywords" content="Moyennisator, Brevet, performances académiques, statistiques scolaires, analyse des notes, éducation, résultats scolaires, suivi des progrès, évaluation, DNL, matières, mathématiques, français, statistiques, évaluation des élèves, contrôle continu">
    <meta name="author" content="Gabriel B.">
    <meta property="og:title" content="Moyennisator 3000 - Analysez vos performances académiques">
    <meta property="og:description" content="Utilisez Moyennisator 3000 pour suivre vos résultats scolaires et obtenir des statistiques sur le Brevet. Améliorez vos performances académiques dès aujourd'hui !">
    <meta property="og:image" content="https://moyennisator3000.study/static/favicon.png">
    <meta property="og:url" content="https://moyennisator3000.study/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Moyennisator 3000 - Analysez vos performances académiques">
    <meta name="twitter:description" content="Suivez vos progrès scolaires avec Moyennisator 3000 et obtenez des statistiques détaillées sur le Brevet.">
    <meta name="twitter:image" content="https://moyennisator3000.study/static/favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="robots" content="index, follow">
    <meta name="theme-color" content="#ffffff">
    <link rel="canonical" href="https://moyennisator3000.study/">

    <!-- Bootstrap & icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --bg-0: #1e3c72;
            --bg-1: #2a5298;
            --card-bg: rgba(255,255,255,0.10);
            --muted: rgba(255,255,255,0.75);
            --accent: #4dc9f6;
            --accent2: #f67019;
            --accent3: #f53794;
            --accent4: #acc236;
        }


        html {
            min-height: 100vh;
            width: 100vw;
        }
        body {
            min-height: 100vh;
            width: 100vw;
            background: linear-gradient(135deg, var(--bg-0) 0%, var(--bg-1) 100%) fixed;
            color: #f3f6fa;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        .navbar, .navbar-brand {
            background: transparent !important;
            color: #fff !important;
        }

        .container-main {
            max-width: 1100px;
            margin: 0 auto;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid rgba(255,255,255,0.10);
            color: inherit;
            box-shadow: 0 2px 12px 0 rgba(30,60,114,0.08);
        }

        .card-header {
            background: rgba(255,255,255,0.07);
            border-bottom: 1px solid rgba(255,255,255,0.10);
        }

        .btn-outline-light, .btn-outline-primary, .btn-outline-success, .btn-outline-danger, .btn-outline-warning {
            color: #fff;
            border-width: 2px;
            border-radius: 0.5rem;
            font-weight: 500;
            margin-right: 0.25rem;
        }
        .btn-outline-light { border-color: var(--accent); background: linear-gradient(90deg, var(--accent), var(--accent2)); }
        .btn-outline-primary { border-color: var(--accent2); background: linear-gradient(90deg, var(--accent2), var(--accent3)); }
        .btn-outline-success { border-color: var(--accent4); background: linear-gradient(90deg, var(--accent4), var(--accent)); }
        .btn-outline-danger { border-color: #e74c3c; background: linear-gradient(90deg, #e74c3c, #f53794); }
        .btn-outline-warning { border-color: #f1c40f; background: linear-gradient(90deg, #f1c40f, #f67019); color: #222; }

        .btn-outline-light:hover, .btn-outline-primary:hover, .btn-outline-success:hover, .btn-outline-danger:hover, .btn-outline-warning:hover {
            filter: brightness(1.1);
            opacity: 0.95;
        }

        .text-muted {
            color: var(--muted) !important;
        }

        /* small helpers used in results page */
        .subject-card { padding: 0.75rem; }
        .grade-badge {
            display: inline-block;
            padding: 0.15rem 0.45rem;
            border-radius: 0.35rem;
            margin-right: 0.25rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: #fff;
        }
        /* Colorful grade badges for individual evaluations (improved greens, readable text) */
        .grade-badge.grade-v-plus {
            background: linear-gradient(90deg, #14532d 0%, #22c55e 100%); /* dark to vivid green */
            color: #fff;
            border: 1px solid #14532d;
        }
        .grade-badge.grade-v {
            background: linear-gradient(90deg, #bbf7d0 0%, #4ade80 100%); /* light to medium green */
            color: #222;
            border: 1px solid #4ade80;
        }
        .grade-badge.grade-j {
            background: linear-gradient(90deg, #f1c40f, #f67019);
            color: #222;
            border: 1px solid #f1c40f;
        }
        .grade-badge.grade-r {
            background: linear-gradient(90deg, #e74c3c, #f53794);
            color: #fff;
            border: 1px solid #e74c3c;
        }

        /* Ensure table text is always readable */
        table, th, td {
            color: #f3f6fa !important;
        }
    </style>

    {% block styles %}{% endblock %}
</head>
<body>

<nav class="navbar navbar-dark shadow-sm mb-4">
    <div class="container container-main">
        <a class="navbar-brand" href="{{ url_for('index') }}">Moyennisator 3000</a>
        <div class="d-flex align-items-center">
            {# use an explicit 'languages' mapping passed from the view when available #}
            {% if languages %}
                {% for code, name in languages.items() %}
                    <a class="btn btn-sm btn-outline-light ms-1" href="{{ url_for('set_language', language=code) }}">{{ name }}</a>
                {% endfor %}
            {% endif %}
        </div>
    </div>
</nav>

<main class="container container-main py-3">
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% set alert_class = 'danger' if category == 'error' else category %}
                <div class="alert alert-{{ alert_class }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
</main>

<footer class="text-center text-muted py-3">
    &copy; {{ datetime.utcnow().year }} Moyennisator 3000
</footer>

<!-- Scripts: Bootstrap, Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js')
            .then(() => console.log("SW ok"))
            .catch(err => console.error("SW pas ok", err));
    });
</script>

<!-- Auto-login (PWA only): store username + SHA256(password) locally and perform seamless POST to /auto_login -->
<script>
// Minimal, async SHA-256 helpers and unobtrusive form hook with transient toast
(function(){
    const LS_KEY = 'moyennisator_auto_login_v1';

    async function sha256Hex(str) {
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
        return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }

    // transient toast utilities - large, centered, obvious
    function showToast(msg) {
        try {
            let t = document.getElementById('moyauto_toast');
            if (!t) {
                t = document.createElement('div');
                t.id = 'moyauto_toast';
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes moyAutoSpin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                    #moyauto_toast {
                        position: fixed !important;
                        top: 50% !important;
                        left: 50% !important;
                        transform: translate(-50%, -50%) !important;
                        background: rgba(30, 60, 114, 0.95) !important;
                        border: 3px solid #4dc9f6 !important;
                        color: #fff !important;
                        padding: 24px 32px !important;
                        border-radius: 12px !important;
                        font-size: 18px !important;
                        font-weight: 600 !important;
                        z-index: 999999 !important;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.4) !important;
                        text-align: center !important;
                        max-width: 80% !important;
                    }
                    #moyauto_spinner {
                        display: inline-block;
                        width: 24px;
                        height: 24px;
                        border: 3px solid rgba(255,255,255,0.3);
                        border-top-color: #4dc9f6;
                        border-radius: 50%;
                        animation: moyAutoSpin 0.8s linear infinite;
                        margin-right: 12px;
                        vertical-align: middle;
                    }
                `;
                document.head.appendChild(style);
                t = document.createElement('div');
                t.id = 'moyauto_toast';
                document.body.appendChild(t);
            }
            const spinner = '<span id="moyauto_spinner"></span>';
            t.innerHTML = spinner + msg;
            t.style.display = 'block';
        } catch(e) { /* silent */ }
    }
    function hideToast() {
        try {
            const t = document.getElementById('moyauto_toast');
            if (t) t.style.display = 'none';
        } catch(e) { /* silent */ }
    }

    // Save credentials (username + hash + pronote url) on normal form submit without changing UI
    function attachFormSaver() {
        try {
            const usernameInput = document.querySelector('input[name="username"]');
            const passwordInput = document.querySelector('input[name="password"]');
            if (!usernameInput || !passwordInput) return;

            const form = passwordInput.form || usernameInput.form || document.querySelector('form');
            if (!form) return;

            form.addEventListener('submit', async function(evt){
                evt.preventDefault();
                try {
                    const username = String(usernameInput.value || '').trim();
                    const password = String(passwordInput.value || '');
                    // read pronote url fields if present
                    const urlSelect = (document.querySelector('select[name="pronote_url_select"]') || {}).value || null;
                    const urlCustom = (document.querySelector('input[name="pronote_url_custom"]') || {}).value || null;
                    if (username && password) {
                        const hash = password;
                        const payload = { username: username, password_sha256: hash, pronote_url_select: urlSelect, pronote_url_custom: urlCustom, ts: Date.now() };
                        try { localStorage.setItem(LS_KEY, JSON.stringify(payload)); } catch(e) { /* ignore storage errors */ }
                    }
                } catch(e) {
                    // ignore hashing/storage errors
                }
                requestAnimationFrame(()=> HTMLFormElement.prototype.submit.call(form));
            }, {passive:false});
        } catch(e) {
            console.error('Auto-login form hook error', e);
        }
    }

    // Only attempt auto-login when app is running as PWA (standalone)
    function isPWA() {
        return (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || window.navigator.standalone === true;
    }

    async function attemptAutoLogin() {
        if (!isPWA()) return;
        // Don't auto-login if we're already on the results page
        if (window.location.pathname !== '/') return;
        
        let stored = null;
        try { stored = JSON.parse(localStorage.getItem(LS_KEY) || 'null'); } catch(e) { stored = null; }
        if (!stored || !stored.username || !stored.password_sha256) return;

        // Use stored pronote url if present, otherwise read current form fields
        const urlSelect = stored.pronote_url_select || (document.querySelector('select[name="pronote_url_select"]') || {}).value || null;
        const urlCustom = stored.pronote_url_custom || (document.querySelector('input[name="pronote_url_custom"]') || {}).value || null;

        showToast('Auto-login…');

        try {
            const res = await fetch('/auto_login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username: stored.username,
                    password_sha256: stored.password_sha256,
                    pronote_url_select: urlSelect,
                    pronote_url_custom: urlCustom,
                }),
                credentials: 'same-origin'
            });

            if (res.ok) {
                const j = await res.json();
                hideToast();
                if (j && j.redirect) {
                    window.location.href = j.redirect;
                    return;
                }
            }

            // any failure: clear stored creds and go back to index
            try { localStorage.removeItem(LS_KEY); } catch(e){}
            hideToast();
            window.location.href = '/';
        } catch(e) {
            try { localStorage.removeItem(LS_KEY); } catch(ex){}
            hideToast();
            window.location.href = '/';
        }
    }

    // Initialize hooks on load
    window.addEventListener('load', function(){
        attachFormSaver();
        // attempt auto-login shortly after load to let service worker/registers finish
        setTimeout(attemptAutoLogin, 200);
    });
})();
</script>

{% block scripts %}{% endblock %}
</body>
</html>